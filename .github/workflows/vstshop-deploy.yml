jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Step A: Get Mgmt Access
      - name: Configure Management Gateway Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::086739225244:role/github-actions-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      # Step B: Chain into Dev (This is what worked before!)
      - name: Configure Dev Account Credentials (Role Hopping)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          role-to-assume: arn:aws:iam::195481994910:role/terraform-execution-role-dev

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -backend-config=../../../backend.ci.hcl

      - name: Terraform Plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -var-file=../../../global.tfvars

  apply:
    needs: plan
    if: github.ref == 'refs/heads/master'
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # YOU MUST REPEAT THE DOUBLE-AUTH HERE
      - name: Configure Management Gateway Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::086739225244:role/github-actions-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure Dev Account Credentials (Role Hopping)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          role-to-assume: arn:aws:iam::195481994910:role/terraform-execution-role-dev

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -backend-config=../../../backend.ci.hcl

      - name: Terraform Apply
        working-directory: ${{ env.TF_DIR }}
        run: terraform apply -auto-approve -var-file=../../../global.tfvars
